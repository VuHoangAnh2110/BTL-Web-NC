@model BTL_Web_NC.ViewModels.ThemTKViewModel
@{
    ViewData["Title"] = "Thêm tài khoản mới";
}

<div class="container my-4">
    <div class="card border-0 shadow-sm rounded-3">
        <div class="card-header bg-gradient-primary text-white py-3 rounded-top">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0 fw-bold">
                    <i class="fas fa-user-plus me-2"></i>Thêm tài khoản mới
                </h3>
                <a asp-action="Index" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left me-1"></i>Quay lại
                </a>
            </div>
        </div>
        
        <div class="card-body p-4">
            <form asp-action="ThemTK" method="post" id="formThemTK">
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm rounded-3 bg-light">
                            <div class="card-header bg-light border-0 pt-3">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-info-circle me-2"></i>Thông tin cơ bản
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="TenTaiKhoan" class="form-label fw-bold">Tên tài khoản <span class="text-danger">*</span></label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                        <input asp-for="TenTaiKhoan" class="form-control" placeholder="Nhập tên tài khoản" />
                                    </div>
                                    <span asp-validation-for="TenTaiKhoan" class="text-danger small"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="Email" class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                        <input asp-for="Email" class="form-control" type="email" placeholder="Nhập email" />
                                    </div>
                                    <span asp-validation-for="Email" class="text-danger small"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="MatKhau" class="form-label fw-bold">Mật khẩu <span class="text-danger">*</span></label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input asp-for="MatKhau" class="form-control" type="password" placeholder="Nhập mật khẩu" />
                                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted">Mật khẩu phải chứa ít nhất 8 ký tự, bao gồm chữ, số và ký tự đặc biệt.</small>
                                    <span asp-validation-for="MatKhau" class="text-danger small d-block mt-1"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="XacNhanMatKhau" class="form-label fw-bold">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                        <input asp-for="XacNhanMatKhau" class="form-control" type="password" placeholder="Xác nhận mật khẩu" />
                                        <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <span asp-validation-for="XacNhanMatKhau" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm rounded-3 bg-light">
                            <div class="card-header bg-light border-0 pt-3">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-address-card me-2"></i>Thông tin chi tiết
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label asp-for="HoTen" class="form-label fw-bold">Họ và tên <span class="text-danger">*</span></label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-id-card"></i></span>
                                        <input asp-for="HoTen" class="form-control" placeholder="Nhập họ và tên" />
                                    </div>
                                    <span asp-validation-for="HoTen" class="text-danger small"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="SoDienThoai" class="form-label fw-bold">Số điện thoại</label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-phone"></i></span>
                                        <input asp-for="SoDienThoai" class="form-control" placeholder="Nhập số điện thoại" />
                                    </div>
                                    <span asp-validation-for="SoDienThoai" class="text-danger small"></span>
                                </div>
                                
                                <div class="mb-3">
                                    <label asp-for="DiaChi" class="form-label fw-bold">Địa chỉ</label>
                                    <div class="input-group mb-1">
                                        <span class="input-group-text"><i class="fas fa-map-marker-alt"></i></span>
                                        <textarea asp-for="DiaChi" class="form-control" rows="3" placeholder="Nhập địa chỉ"></textarea>
                                    </div>
                                    <span asp-validation-for="DiaChi" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm rounded-3 bg-light">
                            <div class="card-header bg-light border-0 pt-3">
                                <h5 class="card-title text-primary">
                                    <i class="fas fa-cogs me-2"></i>Cài đặt tài khoản
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="VaiTro" class="form-label fw-bold">Vai trò <span class="text-danger">*</span></label>
                                            <div class="input-group mb-1">
                                                <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                                <select asp-for="VaiTro" class="form-select">
                                                    <option value="admin">Admin</option>
                                                    <option value="user" selected>User</option>
                                                </select>
                                            </div>
                                            <small class="text-muted">Chọn vai trò phù hợp với người dùng</small>
                                            <span asp-validation-for="VaiTro" class="text-danger small d-block mt-1"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label asp-for="TrangThai" class="form-label fw-bold">Trạng thái <span class="text-danger">*</span></label>
                                            <div class="input-group mb-1">
                                                <span class="input-group-text"><i class="fas fa-toggle-on"></i></span>
                                                <select asp-for="TrangThai" class="form-select">
                                                    <option value="1">Chờ duyệt</option>
                                                    <option value="2" selected>Hoạt động</option>
                                                    <option value="3">Đã khóa</option>
                                                </select>
                                            </div>
                                            <small class="text-muted">Xác định trạng thái hoạt động của tài khoản</small>
                                            <span asp-validation-for="TrangThai" class="text-danger small d-block mt-1"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex justify-content-between">
                    <a asp-action="Index" class="btn btn-secondary px-4 py-2">
                        <i class="fas fa-times me-2"></i>Hủy
                    </a>
                    <button type="submit" class="btn btn-success px-4 py-2">
                        <i class="fas fa-save me-2"></i>Tạo tài khoản
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Chức năng hiện/ẩn mật khẩu
            $('#togglePassword').click(function() {
                const passwordField = $('#MatKhau');
                const passwordFieldType = passwordField.attr('type');
                const icon = $(this).find('i');
                
                if (passwordFieldType === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            $('#toggleConfirmPassword').click(function() {
                const passwordField = $('#XacNhanMatKhau');
                const passwordFieldType = passwordField.attr('type');
                const icon = $(this).find('i');
                
                if (passwordFieldType === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            // Kiểm tra định dạng mật khẩu khi người dùng nhập
            $('#MatKhau').on('input', function() {
                const password = $(this).val();
                const errorSpan = $('[data-valmsg-for="MatKhau"]');
                let isValid = true;
                let errorMessage = '';
                
                if (password.length < 8) {
                    isValid = false;
                    errorMessage = 'Mật khẩu phải có ít nhất 8 ký tự';
                } else if (!/[A-Za-z]/.test(password) || !/[0-9]/.test(password)) {
                    isValid = false;
                    errorMessage = 'Mật khẩu phải chứa cả chữ và số';
                } else if (!/[^A-Za-z0-9]/.test(password)) {
                    isValid = false;
                    errorMessage = 'Mật khẩu phải chứa ít nhất 1 ký tự đặc biệt';
                }
                
                // Hiển thị lỗi ngay lập tức
                if (!isValid) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                    errorSpan.text(errorMessage);
                } else {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    errorSpan.text('');
                }
            });
            
            // Kiểm tra xác nhận mật khẩu
            $('#XacNhanMatKhau').on('input', function() {
                const confirmPassword = $(this).val();
                const password = $('#MatKhau').val();
                const errorSpan = $('[data-valmsg-for="XacNhanMatKhau"]');
                
                if (confirmPassword !== password) {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                    errorSpan.text('Mật khẩu xác nhận không khớp');
                } else {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                    errorSpan.text('');
                }
            });

            // Tạo mật khẩu tự động
            $('#btnGeneratePassword').click(function() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!#$%^&*()-_=+';
                let password = '';
                
                // Đảm bảo có ít nhất 1 chữ hoa
                password += chars.substring(0, 26).charAt(Math.floor(Math.random() * 26));
                
                // Đảm bảo có ít nhất 1 chữ thường
                password += chars.substring(26, 52).charAt(Math.floor(Math.random() * 26));
                
                // Đảm bảo có ít nhất 1 số
                password += chars.substring(52, 62).charAt(Math.floor(Math.random() * 10));
                
                // Đảm bảo có ít nhất 1 ký tự đặc biệt
                password += chars.substring(62).charAt(Math.floor(Math.random() * (chars.length - 62)));
                
                // Thêm các ký tự ngẫu nhiên cho đến khi đạt độ dài 12
                for (let i = password.length; i < 12; i++) {
                    password += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                // Xáo trộn mật khẩu
                password = password.split('').sort(function() { return 0.5 - Math.random() }).join('');
                
                // Gán mật khẩu vào trường input
                $('#MatKhau').val(password).trigger('input');
                $('#XacNhanMatKhau').val(password).trigger('input');
                
                // Hiển thị thông báo
                Swal.fire({
                    icon: 'success',
                    title: 'Đã tạo mật khẩu',
                    text: 'Mật khẩu mạnh đã được tạo tự động',
                    timer: 2000,
                    showConfirmButton: false
                });
            });
        });
    </script>
    
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script src="~/js/QLyTaiKhoan/ThemTK.js"></script>

}